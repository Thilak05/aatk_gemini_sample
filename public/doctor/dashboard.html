<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doctor Dashboard | AI Health Assistant</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="doctor-style.css">
    <style>
        /* Modal Styles */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.5); 
            backdrop-filter: blur(4px);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 10% auto; 
            padding: 30px;
            border: 1px solid #888;
            width: 500px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            animation: slideUp 0.3s ease-out;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        .patient-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .patient-table th, .patient-table td {
            text-align: left;
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
        }
        .patient-table th {
            background-color: #f8fafc;
            font-weight: 600;
            color: var(--text-secondary);
        }
        .patient-table tr:hover {
            background-color: #f1f5f9;
        }
    </style>
</head>
<body>
    <div class="dashboard-layout">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-logo">
                <i class="fa-solid fa-heart-pulse"></i> DocPortal
            </div>
            
            <nav>
                <a href="#" class="nav-item active" onclick="showSection('consultations')">
                    <i class="fa-solid fa-video"></i> Consultations
                </a>
                <a href="#" class="nav-item" onclick="showSection('patients')">
                    <i class="fa-solid fa-user-group"></i> Patients
                </a>
            </nav>

            <div class="doctor-profile" onclick="openProfileModal()" style="cursor: pointer;">
                <div class="avatar" id="doctorInitials">DR</div>
                <div>
                    <div style="font-weight: 600; font-size: 0.9rem;" id="doctorNameDisplay">Loading...</div>
                    <div style="font-size: 0.8rem; color: var(--text-secondary);">Edit Profile</div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Consultations Section -->
            <div id="consultations-section">
                <div class="header-bar">
                    <div>
                        <h1 style="margin: 0; font-size: 1.5rem;">Live Consultations</h1>
                        <p style="margin: 4px 0 0 0; color: var(--text-secondary);">Manage patient requests and video calls</p>
                    </div>
                    <div class="status-badge">
                        <div class="status-dot"></div>
                        Accepting Requests
                    </div>
                </div>

                <div class="dashboard-grid">
                    <!-- Request List Panel -->
                    <div class="panel">
                        <div class="panel-header">
                            <span>Patient Queue</span>
                            <span class="badge" id="queueCount" style="background: #eff6ff; color: #2563eb; padding: 2px 8px; border-radius: 10px; font-size: 0.8rem;">0</span>
                        </div>
                        <div class="request-list" id="requestsList">
                            <div style="text-align: center; padding: 40px 20px; color: var(--text-secondary);">
                                <i class="fa-solid fa-inbox" style="font-size: 2rem; margin-bottom: 10px; opacity: 0.3;"></i>
                                <p>No active requests</p>
                            </div>
                        </div>
                    </div>

                    <!-- Video Stage Panel -->
                    <div class="panel">
                        <div class="consultation-wrapper">
                            <div class="video-stage" id="videoContainer">
                                <div class="waiting-overlay" id="videoPlaceholder">
                                    <i class="fa-solid fa-video-slash" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                                    <h3>No Active Call</h3>
                                    <p style="opacity: 0.7;">Select a patient from the queue to start consultation</p>
                                </div>
                                <video id="remoteVideo" autoplay playsinline></video>
                                <video id="localVideo" autoplay playsinline muted></video>
                                
                                <div class="video-controls hidden" id="videoControls">
                                    <button class="control-btn" onclick="toggleMute()" title="Toggle Mute">
                                        <i class="fa-solid fa-microphone"></i>
                                    </button>
                                    <button class="control-btn" onclick="toggleVideo()" title="Toggle Video">
                                        <i class="fa-solid fa-video"></i>
                                    </button>
                                    <button class="control-btn" onclick="toggleFullScreen()" title="Full Screen">
                                        <i class="fa-solid fa-expand"></i>
                                    </button>
                                    <button class="control-btn danger" onclick="endConsultation()" title="End Call">
                                        <i class="fa-solid fa-phone-slash"></i>
                                    </button>
                                </div>
                            </div>

                            <div class="controls-panel hidden" id="controlsPanel">
                                <div class="patient-info-bar" id="patientInfoBar" style="margin-bottom: 15px; padding: 10px; background: #f8fafc; border-radius: 8px; border: 1px solid var(--border-color); display: flex; gap: 20px; flex-wrap: wrap;">
                                    <!-- Populated by JS -->
                                </div>
                                <div class="notes-grid">
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; font-weight: 500;">Patient Symptoms</label>
                                        <div id="patientSymptoms" style="background: white; padding: 12px; border-radius: 8px; border: 1px solid var(--border-color); height: 100px; overflow-y: auto;">
                                            --
                                        </div>
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; font-weight: 500;">Doctor's Notes</label>
                                        <textarea id="consultationNotes" placeholder="Enter diagnosis and notes..." style="height: 80px;"></textarea>
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; font-weight: 500;">Prescription</label>
                                        <textarea id="consultationPrescription" placeholder="Enter prescription..." style="height: 80px;"></textarea>
                                    </div>
                                </div>
                                <button class="action-btn" onclick="completeConsultation()">
                                    <i class="fa-solid fa-check"></i> Complete Consultation
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Patients Section -->
            <div id="patients-section" class="hidden">
                <div class="header-bar">
                    <div>
                        <h1 style="margin: 0; font-size: 1.5rem;">Patient History</h1>
                        <p style="margin: 4px 0 0 0; color: var(--text-secondary);">List of patients you have attended</p>
                    </div>
                </div>
                <div class="panel" style="padding: 20px;">
                    <table class="patient-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Patient Name</th>
                                <th>Age/Gender</th>
                                <th>Symptoms</th>
                                <th>Diagnosis</th>
                                <th>Prescription</th>
                            </tr>
                        </thead>
                        <tbody id="patientsTableBody">
                            <!-- Rows will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Edit Profile Modal -->
    <div id="profileModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeProfileModal()">&times;</span>
            <h2 style="margin-top: 0;">Edit Profile</h2>
            <form id="profileForm">
                <div class="form-group">
                    <label>Full Name</label>
                    <input type="text" id="editName" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>Specialization</label>
                    <input type="text" id="editSpecialization" class="form-control" required>
                </div>
                <div class="grid-2">
                    <div class="form-group">
                        <label>Hospital</label>
                        <input type="text" id="editHospital" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>Location</label>
                        <input type="text" id="editLocation" class="form-control" required>
                    </div>
                </div>
                <div class="grid-2">
                    <div class="form-group">
                        <label>Contact No</label>
                        <input type="text" id="editContact" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>Gender</label>
                        <select id="editGender" class="form-control" required>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                </div>
                <button type="submit" class="btn-primary">Save Changes</button>
            </form>
        </div>
    </div>

    <!-- History Modal -->
    <div id="historyModal" class="modal">
        <div class="modal-content" style="width: 80%; max-width: 800px;">
            <span class="close" onclick="closeHistoryModal()">&times;</span>
            <h2>Patient Report</h2>
            <div id="historyContent"></div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // --- Auth & Init ---
        const doctorId = localStorage.getItem('doctorId');
        const doctorName = localStorage.getItem('doctorName');

        if (!doctorId) window.location.href = 'index.html';

        // Display Name
        document.getElementById('doctorNameDisplay').textContent = doctorName || 'Doctor';
        if(doctorName) {
            document.getElementById('doctorInitials').textContent = doctorName.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
        }

        // --- Navigation ---
        function showSection(sectionId) {
            document.getElementById('consultations-section').classList.add('hidden');
            document.getElementById('patients-section').classList.add('hidden');
            
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            
            if (sectionId === 'consultations') {
                document.getElementById('consultations-section').classList.remove('hidden');
                document.querySelector('.nav-item:nth-child(1)').classList.add('active');
            } else if (sectionId === 'patients') {
                document.getElementById('patients-section').classList.remove('hidden');
                document.querySelector('.nav-item:nth-child(2)').classList.add('active');
                loadPatients();
            }
        }

        // --- Profile Modal ---
        const modal = document.getElementById("profileModal");

        async function openProfileModal() {
            modal.style.display = "block";
            // Fetch current profile data
            try {
                const res = await fetch(`/doctor/profile/${doctorId}`);
                const data = await res.json();
                if(res.ok) {
                    document.getElementById('editName').value = data.name;
                    document.getElementById('editSpecialization').value = data.specialization;
                    document.getElementById('editHospital').value = data.hospital;
                    document.getElementById('editLocation').value = data.location;
                    document.getElementById('editContact').value = data.contact_no;
                    document.getElementById('editGender').value = data.gender;
                }
            } catch(e) { console.error(e); }
        }

        function closeProfileModal() {
            modal.style.display = "none";
        }

        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }

        document.getElementById('profileForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const updatedData = {
                name: document.getElementById('editName').value,
                specialization: document.getElementById('editSpecialization').value,
                hospital: document.getElementById('editHospital').value,
                location: document.getElementById('editLocation').value,
                contact_no: document.getElementById('editContact').value,
                gender: document.getElementById('editGender').value
            };

            try {
                const res = await fetch(`/doctor/profile/${doctorId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updatedData)
                });
                if(res.ok) {
                    alert('Profile updated successfully');
                    localStorage.setItem('doctorName', updatedData.name);
                    document.getElementById('doctorNameDisplay').textContent = updatedData.name;
                    closeProfileModal();
                } else {
                    alert('Failed to update profile');
                }
            } catch(e) { console.error(e); }
        });

        // --- Patients List ---
        async function loadPatients() {
            const tbody = document.getElementById('patientsTableBody');
            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">Loading...</td></tr>';
            
            try {
                const res = await fetch(`/doctor/patients/${doctorId}`);
                const patients = await res.json();
                
                tbody.innerHTML = '';
                if(patients.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">No patients attended yet.</td></tr>';
                    return;
                }

                patients.forEach(p => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${new Date(p.created_at).toLocaleDateString()}</td>
                        <td>${p.patient_name || 'Anonymous'}</td>
                        <td>${p.age || '-'} / ${p.gender || '-'}</td>
                        <td>${p.symptoms ? p.symptoms.substring(0, 30) + '...' : '-'}</td>
                        <td>
                            <button class="btn-primary" style="padding: 4px 8px; font-size: 0.8rem; width: auto;" onclick="showHistory('${encodeURIComponent(JSON.stringify(p))}')">
                                View Report
                            </button>
                        </td>
                        <td>${p.prescription || '-'}</td>
                    `;
                    tbody.appendChild(row);
                });
            } catch(e) {
                console.error(e);
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; color:red;">Error loading data</td></tr>';
            }
        }

        // --- Socket & WebRTC (Existing Logic) ---
        const socket = io(); // No auth token used in server yet, so simple connect

        let peerConnection;
        let currentPatientId = null;
        let currentConsultationId = null;
        let currentPatientData = null;
        const config = {
            iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
        };

        socket.on('connect', () => {
            console.log('Connected as Doctor');
            socket.emit('doctor_login', doctorId);
        });

        socket.on('new_patient_request', (data) => {
            addRequestToQueue(data);
        });

        socket.on('request_taken', (data) => {
            const card = document.getElementById(`req-${data.patientSocketId}`);
            if (card) {
                card.remove();
                updateQueueCount();
            }
        });

        socket.on('offer', async (data) => {
            if (currentPatientId !== data.sender) return;
            
            peerConnection = new RTCPeerConnection(config);
            
            peerConnection.onicecandidate = event => {
                if (event.candidate) {
                    socket.emit('candidate', {
                        target: currentPatientId,
                        candidate: event.candidate
                    });
                }
            };

            peerConnection.ontrack = event => {
                const remoteVideo = document.getElementById('remoteVideo');
                remoteVideo.srcObject = event.streams[0];
                document.getElementById('videoPlaceholder').classList.add('hidden');
                document.getElementById('videoControls').classList.remove('hidden');
            };

            const localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            document.getElementById('localVideo').srcObject = localStream;
            
            localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

            await peerConnection.setRemoteDescription(new RTCSessionDescription(data.sdp));
            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);

            socket.emit('answer', {
                target: currentPatientId,
                sdp: answer
            });
            
            document.getElementById('controlsPanel').classList.remove('hidden');
        });

        socket.on('candidate', async (data) => {
            if (currentPatientId !== data.sender) return;
            try {
                await peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
            } catch (e) {
                console.error('Error adding received ice candidate', e);
            }
        });

        function addRequestToQueue(data) {
            const list = document.getElementById('requestsList');
            const emptyState = list.querySelector('.fa-inbox')?.parentElement;
            if (emptyState) emptyState.remove();

            const card = document.createElement('div');
            card.className = 'request-card';
            card.id = `req-${data.socketId}`;
            // Store full data in dataset for retrieval
            card.dataset.fullData = JSON.stringify(data);
            
            card.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div>
                        <h4>${data.patientName || 'Anonymous Patient'}</h4>
                        <p>${data.symptoms.substring(0, 50)}...</p>
                    </div>
                    <button class="btn-primary" style="padding: 6px 12px; font-size: 0.8rem; width: auto;" onclick="acceptRequest('${data.socketId}')">
                        Accept
                    </button>
                </div>
            `;
            list.appendChild(card);
            updateQueueCount();
        }

        function updateQueueCount() {
            const count = document.getElementById('requestsList').children.length;
            document.getElementById('queueCount').textContent = count;
        }

        window.acceptRequest = function(socketId) {
            if (currentPatientId) {
                if(!confirm('End current consultation to accept new one?')) return;
                endConsultation();
            }

            const card = document.getElementById(`req-${socketId}`);
            if(!card) return;
            
            const data = JSON.parse(card.dataset.fullData);
            currentPatientId = socketId;
            currentConsultationId = data.consultationId;
            currentPatientData = data;

            // Populate Patient Info
            document.getElementById('patientSymptoms').textContent = data.symptoms;
            
            const infoBar = document.getElementById('patientInfoBar');
            const vitals = data.vitals || {};
            
            infoBar.innerHTML = `
                <div><strong>Name:</strong> ${data.patientName}</div>
                <div><strong>Age/Gender:</strong> ${data.age || '-'} / ${data.gender || '-'}</div>
                <div><strong>Height:</strong> ${vitals.height || '-'} cm</div>
                <div><strong>Weight:</strong> ${vitals.weight || '-'} kg</div>
                <div><strong>Temp:</strong> ${vitals.temperature || '-'} Â°F</div>
                <div><strong>SpO2:</strong> ${vitals.spo2 || '-'}%</div>
                <div><strong>HR:</strong> ${vitals.heartrate || '-'} bpm</div>
            `;
            
            document.querySelectorAll('.request-card').forEach(c => c.classList.remove('active'));
            card.classList.add('active');

            socket.emit('accept_request', { 
                patientSocketId: socketId, 
                doctorId: doctorId,
                consultationId: currentConsultationId 
            });
            
            document.getElementById('videoPlaceholder').innerHTML = `
                <i class="fa-solid fa-spinner fa-spin" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                <h3>Connecting...</h3>
                <p>Waiting for patient connection</p>
            `;
        };

        window.completeConsultation = async function() {
            if (!currentConsultationId) {
                endConsultation();
                return;
            }

            const notes = document.getElementById('consultationNotes').value;
            const prescription = document.getElementById('consultationPrescription').value;
            
            if (!notes.trim() && !prescription.trim()) {
                if(!confirm('Complete consultation without notes or prescription?')) return;
            }

            try {
                // Save to DB
                await fetch('/doctor/response', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        consultation_id: currentConsultationId,
                        doctor_notes: notes,
                        prescription: prescription
                    })
                });

                // Notify Patient via Socket
                socket.emit('consultation_completed', { 
                    target: currentPatientId, 
                    notes: notes,
                    prescription: prescription 
                });

            } catch (e) {
                console.error('Error saving consultation:', e);
                alert('Error saving consultation data, but ending call.');
            }

            endConsultation();
        };

        window.toggleMute = function() {
            const localVideo = document.getElementById('localVideo');
            if (localVideo.srcObject) {
                const audioTrack = localVideo.srcObject.getAudioTracks()[0];
                if (audioTrack) {
                    audioTrack.enabled = !audioTrack.enabled;
                    const btn = document.querySelector('button[onclick="toggleMute()"]');
                    btn.innerHTML = audioTrack.enabled ? '<i class="fa-solid fa-microphone"></i>' : '<i class="fa-solid fa-microphone-slash"></i>';
                    btn.classList.toggle('danger', !audioTrack.enabled);
                }
            }
        };

        window.toggleVideo = function() {
            const localVideo = document.getElementById('localVideo');
            if (localVideo.srcObject) {
                const videoTrack = localVideo.srcObject.getVideoTracks()[0];
                if (videoTrack) {
                    videoTrack.enabled = !videoTrack.enabled;
                    const btn = document.querySelector('button[onclick="toggleVideo()"]');
                    btn.innerHTML = videoTrack.enabled ? '<i class="fa-solid fa-video"></i>' : '<i class="fa-solid fa-video-slash"></i>';
                    btn.classList.toggle('danger', !videoTrack.enabled);
                }
            }
        };

        window.endConsultation = function() {
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            
            const localVideo = document.getElementById('localVideo');
            if (localVideo.srcObject) {
                localVideo.srcObject.getTracks().forEach(track => track.stop());
                localVideo.srcObject = null;
            }

            document.getElementById('videoControls').classList.add('hidden');
            document.getElementById('controlsPanel').classList.add('hidden');
            document.getElementById('videoPlaceholder').classList.remove('hidden');
            document.getElementById('videoPlaceholder').innerHTML = `
                <i class="fa-solid fa-video-slash" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                <h3>No Active Call</h3>
                <p style="opacity: 0.7;">Select a patient from the queue to start consultation</p>
            `;

            if (currentPatientId) {
                const card = document.getElementById(`req-${currentPatientId}`);
                if (card) card.remove();
                updateQueueCount();
            }

            currentPatientId = null;
            currentConsultationId = null;
            currentPatientData = null;
            document.getElementById('consultationNotes').value = '';
            document.getElementById('consultationPrescription').value = '';
            document.getElementById('patientSymptoms').textContent = '--';
            document.getElementById('patientInfoBar').innerHTML = '';
        };

        window.toggleFullScreen = function() {
            const videoStage = document.getElementById('videoContainer');
            videoStage.classList.toggle('fullscreen');
            const btn = document.querySelector('button[onclick="toggleFullScreen()"]');
            const isFullscreen = videoStage.classList.contains('fullscreen');
            btn.innerHTML = isFullscreen ? '<i class="fa-solid fa-compress"></i>' : '<i class="fa-solid fa-expand"></i>';
        };

        window.showHistory = function(patientDataStr) {
            const data = JSON.parse(decodeURIComponent(patientDataStr));
            const modal = document.getElementById('historyModal');
            const content = document.getElementById('historyContent');
            
            const diagnosisHtml = data.diagnosis ? data.diagnosis.replace(/\n/g, '<br>') : 'No diagnosis available.';
            
            content.innerHTML = `
                <div class="grid-2" style="margin-bottom: 20px;">
                    <div>
                        <h3>Patient Details</h3>
                        <p><strong>Name:</strong> ${data.patient_name}</p>
                        <p><strong>Age/Gender:</strong> ${data.age} / ${data.gender}</p>
                        <p><strong>Date:</strong> ${new Date(data.created_at).toLocaleString()}</p>
                    </div>
                    <div>
                        <h3>Vitals & Symptoms</h3>
                        <p><strong>Symptoms:</strong> ${data.symptoms}</p>
                    </div>
                </div>
                <div style="background: #f8fafc; padding: 20px; border-radius: 8px; border: 1px solid #e2e8f0;">
                    <h3 style="margin-top: 0; color: #2563eb;">AI Analysis & Diagnosis</h3>
                    <div style="line-height: 1.6;">${diagnosisHtml}</div>
                </div>
                <div style="margin-top: 20px;">
                    <h3>Doctor's Notes & Prescription</h3>
                    <p><strong>Notes:</strong> ${data.doctor_notes || '-'}</p>
                    <p><strong>Prescription:</strong> ${data.prescription || '-'}</p>
                </div>
            `;
            
            modal.style.display = "block";
        };

        window.closeHistoryModal = function() {
            document.getElementById('historyModal').style.display = "none";
        };
        
        window.onclick = function(event) {
            const modal = document.getElementById('historyModal');
            if (event.target == modal) {
                modal.style.display = "none";
            }
        };
    </script>
</body>
</html>